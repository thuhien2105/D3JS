<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <style>
        /* Add any necessary CSS styles */
    </style>
</head>

<body>

<!-- Choose an element to contain the bar chart -->
<div id="bar-chart-container"></div>

<script>
    // Select container and set chart dimensions
    var container = d3.select('#bar-chart-container');
    var width = 500;
    var height = 400;
    var margin = { top: 30, right: 30, bottom: 70, left: 70 };

    // Create scales for x and y axes
    var xScale = d3.scaleBand().range([0, width]).padding(0.1);
    var yScale = d3.scaleLinear().range([height, 0]);

    // Set up SVG element and attributes
    var svg = container.append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    // Read data from the Excel file
    var excelFile = './data/supermarket_sales.xls';
    var branchColumn = 'Branch';
    var totalColumn = 'Total'; // Assuming a column named "Total" for the total data

    // Use SheetJS to read the data
    var workbook;
    var xhr = new XMLHttpRequest();
    xhr.open('GET', excelFile, true);
    xhr.responseType = 'arraybuffer';
    xhr.onload = function (e) {
        var arraybuffer = xhr.response;
        var data = new Uint8Array(arraybuffer);
        workbook = XLSX.read(data, { type: 'array' });

        // Get data from the first sheet
        var sheetName = workbook.SheetNames[0];
        var sheet = workbook.Sheets[sheetName];

        // Convert data to JSON array
        var jsonData = XLSX.utils.sheet_to_json(sheet);

        // Calculate the total sum for each branch
        var branchData = d3.nest()
            .key(d => d[branchColumn])
            .rollup(v => d3.sum(v, d => d[totalColumn]))
            .entries(jsonData);

        // Process data
        var branchNames = branchData.map(d => d.key);
        var branchTotals = branchData.map(d => d.value);

        // Set domains for x and y scales
        xScale.domain(branchNames);
        yScale.domain([0, d3.max(branchTotals)]);


        // Draw the bar chart
        svg.selectAll('rect')
            .data(branchData)
            .enter().append('rect')
            .attr('x', d => xScale(d.key))
            .attr('y', d => yScale(d.value))
            .attr('width', xScale.bandwidth())
            .attr('height', d => height - yScale(d.value))
            .attr('fill', 'steelblue'); // Change 'steelblue' to the desired shade of blue

        // Add x and y axes
        svg.append('g')
            .attr('transform', 'translate(0,' + height + ')')
            .call(d3.axisBottom(xScale)
                .tickSize(0)  // Set tick size to 0 to remove tick marks
                .tickFormat('') // Set tick format to an empty string to hide tick labels
            )
            .selectAll('text')
            .style('text-anchor', 'end');
        svg.selectAll('.label-text')
            .data(branchData)
            .enter().append('text')
            .attr('class', 'label-text')
            .attr('x', d => xScale(d.key) + xScale.bandwidth() / 2)
            .attr('y', height + 15) // Adjust the y-coordinate as needed
            .attr('text-anchor', 'middle')
            .text(d => d.key)

        svg.append('g')
            .call(d3.axisLeft(yScale));

        // Add labels
        svg.selectAll('text.label')
            .data(branchData)
            .enter().append('text')
            .attr('class', 'label')
            .attr('x', d => xScale(d.key) + xScale.bandwidth() / 2)
            .attr('y', d => yScale(d.value) - 5)
            .attr('text-anchor', 'middle')
            .text(d => d3.format('.2s')(d.value)); // Format the label as desired

        // Add y-axis label
        svg.append('text')
            .attr('transform', 'rotate(-90)')
            .attr('y', 0 - margin.left)
            .attr('x', 0 - height / 2)
            .attr('dy', '1em')
            .style('text-anchor', 'middle')
            .text('Total Sum');

        // Add x-axis title
        svg.append('text')
            .attr('y', height + margin.bottom - 50)
            .attr('x', width / 2)
            .attr('dy', '1em')
            .style('text-anchor', 'middle')
            .text('Branches');
        // Add title
        svg.append('text')
            .attr('y', height + margin.bottom - 15)
            .attr('x', width / 2)
            .attr('dy', '0em')
            .style('text-anchor', 'middle')
            .text('Hình 5. Biểu đồ tổng doanh số của các chi nhánh.');
    };

    xhr.send();
</script>

</body>

</html>
