<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <style>
        /* Add any necessary CSS styles */
    </style>
</head>

<body>

<!-- Choose an element to contain the pie chart -->
<div id="pie-chart-container"></div>

<script>
    // Select container and set chart dimensions
    var container = d3.select('#pie-chart-container');
    var width = 500;
    var height = 400;
    var radius = Math.min(width, height) / 2;

    // Set up SVG element and attributes
    var svg = container.append('svg')
        .attr('width', width)
        .attr('height', height)
        .append('g')
        .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');

    // Read data from the Excel file
    var excelFile = './data/supermarket_sales.xls';
    var customerTypeColumn = 'Customer type';
    var totalColumn = 'Total'; // Assuming a column named "Total" for the total data

    // Use SheetJS to read the data
    var workbook;
    var xhr = new XMLHttpRequest();
    xhr.open('GET', excelFile, true);
    xhr.responseType = 'arraybuffer';
    xhr.onload = function (e) {
        var arraybuffer = xhr.response;
        var data = new Uint8Array(arraybuffer);
        workbook = XLSX.read(data, { type: 'array' });

        // Get data from the first sheet
        var sheetName = workbook.SheetNames[0];
        var sheet = workbook.Sheets[sheetName];

        // Convert data to JSON array
        var jsonData = XLSX.utils.sheet_to_json(sheet);

        // Calculate the total sum for each customer type
        var customerTypeData = d3.nest()
            .key(d => d[customerTypeColumn])
            .rollup(v => d3.sum(v, d => d[totalColumn]))
            .entries(jsonData);

        // Create a pie chart based on the total values
        var pie = d3.pie().value(d => d.value);
        var arc = d3.arc().outerRadius(radius - 30).innerRadius(0);

        var color = d3.scaleOrdinal(d3.schemeCategory10);

        // Generate the pie chart
        var pieChart = svg.selectAll('path')
            .data(pie(customerTypeData))
            .enter().append('path')
            .attr('d', arc)
            .attr('fill', (d, i) => color(i))
            .attr('stroke', 'white') // Add white border for better visibility
            .style('stroke-width', '2px'); // Set border width

        // Add labels and percentages to the pie chart
        var label = d3.arc().outerRadius(radius).innerRadius(radius - 80);
        svg.selectAll('text')
            .data(pie(customerTypeData))
            .enter().append('text')
            .attr('transform', d => 'translate(' + label.centroid(d) + ')')
            .attr('dy', '0.35em')
            .text(d => `${d.data.key} (${(d.data.value / d3.sum(customerTypeData, d => d.value) * 100).toFixed(2)}%)`)
            .style('text-anchor', 'middle')
            .style('font-size', '12px'); // Set font size

        // Add title to the pie chart
        svg.append('text')
            .attr('y', 190)
            .attr('x', 20)
            .attr('dy', '0em')
            .style('text-anchor', 'middle')
            .text('Hình 6. Biểu đồ tỷ lệ mua hàng của các loại khách hàng.');
    };

    xhr.send();
</script>

</body>

</html>
